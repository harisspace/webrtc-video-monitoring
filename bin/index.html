<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEBRTC</title>
    <script>
        window.addEventListener("load", function (e) {
            // global websocket instance
            let ws
            // html
            let btnOpenCamera = document.getElementById("btn-open-camera")
            let btnCloseCamera = document.getElementById("btn-close-camera")
            let remoteVideo = document.getElementById("remote-video")
            let textSDPOffer = document.getElementById("sdp-offer")
            let textSDPAnswer = document.getElementById("sdp-answer")
            let textConvert = document.getElementById("convert-base64")

          
            // webrtc config
            let rtcpc

            textConvert.onclick = (e) => {
                sd = textSDPAnswer.value
                rtcpc.setRemoteDescription(new RTCSessionDescription(JSON.parse(atob(sd))))
            }


            const offerOptions = {
                offerToReceiveVideo: 1
            }

            const iceServers = {
                'iceServer': [
                    {'urls': 'stun:stun.l.google.com:19302'},
                    {'urls': 'stun:stun.services.mozilla.com'}
                ]
            }

               //  // websocket
               ws = new WebSocket("{{.}}")

                ws.onopen = (e) => {
                    console.log("ws open")
                }

                ws.onclose = (e) => {
                    console.log("ws close")
                }

                ws.onmessage = (e) => {
                    let msg = JSON.parse(e.data)
                    console.log(msg)
                    switch (msg.topic) {
                        case 'candidate':
                            console.log('candidate coming')
                            const candidate = new RTCIceCandidate(JSON.parse(msg.data))
                            rtcpc.addIceCandidate(candidate)
                                .catch(err => console.log(err))
                            break
                        case 'answer':
                            console.log('answer coming')
                            rtcpc.setRemoteDescription(JSON.parse(msg.data))
                            break;
                        default:
                            break;
                    }
                }

            // event
            btnOpenCamera.onclick = async (e) => {
                rtcpc = new RTCPeerConnection(iceServers)
                rtcpc.onsignalingstatechange = signalingStateCallback
                rtcpc.oniceconnectionstatechange = iceStateCallback
                rtcpc.onconnectionstatechange = connStateCallback
                rtcpc.onicecandidate = onIceCandidate
                rtcpc.ontrack = onAddStream
                rtcpc.addTransceiver('video', {
                    'direction': 'recvonly'
                })
                const sessionDescription = await rtcpc.createOffer()
                rtcpc.setLocalDescription(sessionDescription)
                console.log("offer, sending: ", sessionDescription)
                ws.send(JSON.stringify({
                    topic: 'offer',
                    data: JSON.stringify(sessionDescription)
                }))
            }

            // callback
            function onAddStream(e) {
                console.log("got remote stream")
                remoteVideo.srcObject = e.streams[0]
            }

            function signalingStateCallback() {
                let state;
                if (rtcpc) {
                    state = rtcpc.signalingState
                    console.log("signaling state: ", state)
                }
            }

            function iceStateCallback() {
                let iceState
                if (rtcpc) {
                    iceState = rtcpc.iceConnectionState
                    console.log("ICE connection state: ", iceState)
                }
            }

            function connStateCallback() {
                let connState
                if (rtcpc) {
                    connState = rtcpc.connectionState
                    console.log("Connection state: ", connectionState)
                }
            }

            function onIceCandidate(e) {
                if (e.candidate != null & ws != null) {
                    offerSD = rtcpc.localDescription
                    console.log('ice candidate', e.candidate, "\noffer: ",offerSD)
                    textSDPOffer.innerText = JSON.stringify(offerSD)
                    console.log('candidate sending')
                    ws.send(JSON.stringify({
                        topic: 'candidate',
                        data: JSON.stringify(offerSD)
                    }))
                }
            }

            window.copySDP = () => {
                textSDPOffer.focus()
                textSDPOffer.select()
                try {
                    const success = document.execCommand("copy")
                } catch (err) {
                    consle.log(err)
                }
            }
        })
    </script>
</head>
<body>
    <h1>Webrtc</h1>
    <button id="btn-open-camera">Open camera</button>
    <button id="btn-close-camera">Close camera</button>
    <br>
    <div>
        <video id="remote-video" autoplay playsinline></video>
    </div>
    <div>
        <textarea id="sdp-offer" cols="30" rows="10"></textarea>
        <button onclick="window.copySDP()">copy sd</button>
        <br>
        <textarea id="sdp-answer" cols="30" rows="10"></textarea>
        <button id="convert-base64">start</button>
    </div>
</body>
</html>