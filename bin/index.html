<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEBRTC</title>
    <script>
        window.addEventListener("load", function (e) {
            // html
            let btnOpenCamera = document.getElementById("btn-open-camera")
            let btnCloseCamera = document.getElementById("btn-close-camera")
            let remoteVideo = document.getElementById("remote-video")
            let textSDPOffer = document.getElementById("sdp-offer")
            let textSDPAnswer = document.getElementById("sdp-answer")
            let textConvert = document.getElementById("convert-base64")

          
            // webrtc config
            let rtcpc

            textConvert.onclick = (e) => {
                sd = textSDPAnswer.value
                rtcpc.setRemoteDescription(new RTCSessionDescription(JSON.parse(atob(sd))))
            }


            const offerOptions = {
                offerToReceiveVideo: 1
            }

            const iceServers = {
                'iceServer': [
                    {'urls': 'stun:stun.l.google.com:19302'}
                ]
            }

            // event
            btnOpenCamera.onclick = async (e) => {
                //  // websocket
                // ws = new WebSocket("{{.}}")

                rtcpc = new RTCPeerConnection(iceServers)
                rtcpc.onsignalingstatechange = signalingStateCallback
                rtcpc.oniceconnectionstatechange = iceStateCallback
                rtcpc.onconnectionstatechange = connStateCallback
                rtcpc.onicecandidate = onIceCandidate
                rtcpc.ontrack = onAddStream
                rtcpc.addTransceiver('video', {
                    'direction': 'recvonly'
                })
                const sessionDescription = await rtcpc.createOffer()
                rtcpc.setLocalDescription(sessionDescription)
                console.log("offer, data: ", sessionDescription)
            }

            // callback
            function onAddStream(e) {
                console.log("got remote stream")
                remoteVideo.srcObject = e.streams[0]
            }

            function signalingStateCallback() {
                let state;
                if (rtcpc) {
                    state = rtcpc.signalingState
                    console.log("signaling state: ", state)
                }
            }

            function iceStateCallback() {
                let iceState
                if (rtcpc) {
                    iceState = rtcpc.iceConnectionState
                    console.log("ICE connection state: ", iceState)
                }
            }

            function connStateCallback() {
                let connState
                if (rtcpc) {
                    connState = rtcpc.connectionState
                    console.log("Connection state: ", connectionState)
                }
            }

            function onIceCandidate(e) {
                if (e.candidate === null) {
                    offerSD = rtcpc.localDescription
                    console.log('ice candidate', e.candidate, "\noffer: ",offerSD)
                    textSDPOffer.innerText = btoa(JSON.stringify(offerSD))
                }
            }

            window.copySDP = () => {
                textSDPOffer.focus()
                textSDPOffer.select()
                try {
                    const success = document.execCommand("copy")
                } catch (err) {
                    consle.log(err)
                }
            }
        })
    </script>
</head>
<body>
    <h1>Webrtc</h1>
    <button id="btn-open-camera">Open camera</button>
    <button id="btn-close-camera">Close camera</button>
    <br>
    <div>
        <video id="remote-video" autoplay></video>
    </div>
    <div>
        <textarea id="sdp-offer" cols="30" rows="10"></textarea>
        <button onclick="window.copySDP()">copy sd</button>
        <br>
        <textarea id="sdp-answer" cols="30" rows="10"></textarea>
        <button id="convert-base64">start</button>
    </div>
</body>
</html>
