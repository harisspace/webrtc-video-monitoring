<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEBRTC</title>
    <link rel="stylesheet" href="/static/style.css">
    <script>
        window.addEventListener("load", function (e) {
    // global websocket instance
    let ws, sendChannel
    // html
    let btnOpenCamera1 = document.getElementsByClassName("btn-open-camera")[0]
    let btnCloseCamera = document.getElementById("btn-close-camera")
    let remoteVideo = document.getElementById("remote-video")
    let goLeft = document.getElementById("go-left")
    let goRight = document.getElementById("go-right")
  
    // webrtc config
    let rtcpc

    const iceServers = {
        'iceServer': [
            {'urls': 'stun:stun.l.google.com:19302'},
            {'urls': 'stun:stun.services.mozilla.com'}
        ]
    }

        // websocket
        ws = new WebSocket("{{.}}")

        ws.onopen = (e) => {
            console.log("ws open")
        }

        ws.onclose = (e) => {
            console.log("ws close")
        }

        ws.onmessage = (e) => {
            let msg = JSON.parse(e.data)
            switch (msg.topic) {
                case 'candidate':
                    console.log('ice candidate-raspberry', JSON.parse(msg.data))
                    const candidate = new RTCIceCandidate(JSON.parse(msg.data))
                    rtcpc.addIceCandidate(candidate)
                        .catch(err => console.log(err))
                    break
                case 'answer':
                    console.log('answer coming')
                    rtcpc.setRemoteDescription(JSON.parse(msg.data))
                    break;
                default:
                    break;
            }
        }

    // ===== EVENT =====
    // ===== CAMERA EVENT WITH WEBRTC =====
    btnOpenCamera1.onclick = async (e) => {
        rtcpc = new RTCPeerConnection(iceServers)
        rtcpc.onsignalingstatechange = signalingStateCallback
        rtcpc.oniceconnectionstatechange = iceStateCallback
        rtcpc.onconnectionstatechange = connStateCallback
        rtcpc.onicecandidate = onIceCandidate
        rtcpc.ontrack = onAddStream
        rtcpc.addTransceiver('video', {
            'direction': 'recvonly'
        })
        rtcpc.addTransceiver('audio', {
            'direction': 'recvonly'
        })
        sendChannel = rtcpc.createDataChannel('foo')
        sendChannel.onclose = () => console.log('sendChannel has closed')
        sendChannel.onopen = () => console.log('sendChannel has opened')
        sendChannel.onmessage = e => console.log(`Message from DataChannel '${sendChannel.label}' payload '${e.data}'`)
        const sessionDescription = await rtcpc.createOffer()
        rtcpc.setLocalDescription(sessionDescription)
        console.log("offer sending: ", sessionDescription)
        ws.send(JSON.stringify({
            topic: 'offer',
            data: JSON.stringify(sessionDescription)
        }))
    }

    // callback
    function onAddStream(e) {
        console.log("got remote stream")
        const el = document.createElement(e.track.kind)
        el.srcObject = e.streams[0]
        el.controls = true
        el.autoplay = true
        remoteVideo.appendChild(el)
    }

    function signalingStateCallback() {
        let state;
        if (rtcpc) {
            state = rtcpc.signalingState
            console.log("signaling state: ", state)
        }
    }

    function iceStateCallback() {
        let iceState
        if (rtcpc) {
            iceState = rtcpc.iceConnectionState
            console.log("ICE connection state: ", iceState)
        }
    }

    function connStateCallback() {
        let connState
        if (rtcpc) {
            connState = rtcpc.connectionState
            console.log("Connection state: ", connectionState)
        }
    }

    function onIceCandidate(e) {
        if (e.candidate != null & ws != null) {
            offerSD = rtcpc.localDescription
            console.log('ice candidate-client', e.candidate, "\noffer: ",offerSD)
            ws.send(JSON.stringify({
                topic: 'candidate',
                data: JSON.stringify(offerSD)
            }))
        }
    }

    // ==== SERVO EVENT WITH DATA CHANNEL ====
    goLeft.onclick = () => {
        sendChannel.send("go-left")
    }

    goRight.onclick = () => {
        sendChannel.send("go-right")
    }
})
    </script>
</head>
<body>
     <div class="base-camera-wrapper">
        <div class="camera-wrapper">
            <div>
                <img src="/static/img/logitech-1080.jpeg" alt="logitech 1080HD">
            </div>
            <button class="btn-open-camera">Lihat kamera</button>
        </div>
    </div>
    <div class="base-video-wrapper">
        <div id='remote-video'></div>
        <div class="arrow-wrapper">
            <div class="arrow">
                <button id="go-left">kiri</button>
                <button id="go-right">kanan</button>
            </div>
            <div class="arrow-explanation">

            </div>
        </div>
    </div>
</body>
</html>
